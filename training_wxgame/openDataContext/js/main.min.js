var egret=window.egret,__reflect=this&&this.__reflect||function(t,e,i){t.__class__=e,i?i.push(e):i=[e],t.__types__=t.__types__?i.concat(t.__types__):i},__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var a in e)e.hasOwnProperty(a)&&(t[a]=e[a]);i.prototype=e.prototype,t.prototype=new i},Main=function(t){function e(){var e=t.call(this)||this;return e.stageW=750,e.stageH=1334,e.listY=242,e.listWidth=640,e.itemHeight=100,e.itemDis=0,e.itemNumPerPage=7,e.myItemDisList=20,e.scrollView=new egret.ScrollView,e.item_bg_color1=2039331,e.item_bg_color2=2828848,e.item_rankx=40,e.item_rankwidth=50,e.item_rankheight=36,e.item_ranksize=36,e.item_rankcolor=16777215,e.item_rankfont="SimHei",e.item_headx=98,e.item_headwidth=48,e.item_headheight=48,e.item_namex=170,e.item_namewidth=264,e.item_nameheight=36,e.item_namesize=30,e.item_namecolor=16777215,e.item_namefont="SimHei",e.item_scorex=440,e.item_scorewidth=150,e.item_scoreheight=36,e.item_scoresize=36,e.item_scorecolor=16777215,e.item_scorefont="SimHei",wx.onMessage(function(t){console.log("openData:onMessage:",t);var i=t.command;switch(e.userinfo=t.userinfo,e.stageW=t.width,e.stageH=t.height,e.shareTicket=t.shareTicket,e.sorttype=t.sorttype,e.sortkey=t.sortkey,e.params=t.params,e.closeCloud(),e.initBg(),i){case"openrank":e.initRankData(),null==e.shareTicket?e.openFriendCloud():e.openGroupCloud();break;default:e.initCommand(i)}}),e}return __extends(e,t),e.prototype.initBg=function(){var t=this.stage.stageWidth,e=this.stage.stageHeight;console.log("openData:initBg:",t,e),this.scaleX=t/this.stageW,this.scaleY=e/this.stageH},e.prototype.initCommand=function(t){var e=this;wx.getFriendCloudStorage({keyList:[this.sortkey],success:function(i){e.initItemsData(t,i.data)},fail:function(t){console.log("getFriendCloudStorage:error:",t)},complete:function(){console.log("getFriendCloudStorage:complete:")}})},e.prototype.initItemsData=function(t,e){for(var i,a=null!=this.userinfo.avatarUrl?this.userinfo.avatarUrl:"-1",r=-1,n=[],s=0;s<e.length;s++){var h=e[s];null!=h&&null!=h.KVDataList&&null!=h.KVDataList[0]&&n.push(h)}n=n.sort(this.sortfun),1==this.sorttype&&n.reverse();for(var s=0;s<n.length;s++){var h=n[s];a==h.avatarUrl&&(i=h,r=s)}switch(t){case"nextscore":this.initNextScore(n);break;case"exceed":this.initExceed(r,n);break;case"near":this.initNear(r,n);break;case"exceedfriend":this.initExceedFriend(r,n)}},e.prototype.initNextScore=function(t){var e=this;console.log("initNextScore:",t);var i=-2,a=parseInt(this.params.myscore);t:for(var r=0;r<t.length;r++)for(var n=t[r],s=n.KVDataList,h=0;h<s.length;h++){var o=s[h];if(o.key==this.sortkey){var l=parseInt(o.value);if(console.log("compare:",r,a,l),1==this.sorttype&&l>a){i=0==r?-1:r-1;break t}if(2==this.sorttype&&a>l){i=0==r?-1:r-1;break t}}}-2==i&&(i=t.length-1);var d=t[i];if(null!=d){var c=new egret.DisplayObjectContainer;c.x=this.params.x,c.y=this.params.y,this.addChild(c);var m=new egret.Shape;m.graphics.beginFill(2039331),m.graphics.drawRect(0,0,this.params.w,this.params.h),m.graphics.endFill(),c.addChild(m);var g=(this.params.h-this.params.w)/2,p=this.createTextFieldNew(null,0,this.params.w,null,this.params.w,g,16777215,24);p.text="即将超越",c.addChild(p);var u=new egret.ImageLoader;u.once(egret.Event.COMPLETE,function(t){var i=t.currentTarget,a=new egret.Texture;a._setBitmapData(i.data);var r=e.createBitmapNew(a,null,g,e.params.w,null,0,e.params.w,e.params.w);c.addChild(r)},this),u.load(d.avatarUrl);var v=this.createTextFieldNew(null,this.params.w+g,this.params.w,null,this.params.w,g,16777215,24);v.text=this.formatNameString(this.checkSpeName(d.nickname)),c.addChild(v)}},e.prototype.initExceed=function(t,e){var i=this;console.log("initNextScore:",t,e);var a=t+1,r=a>=0?e[a]:null;if(null!=r){var n=new egret.DisplayObjectContainer;n.x=this.params.x,n.y=this.params.y,this.addChild(n);var s=new egret.Shape;s.graphics.beginFill(2039331),s.graphics.drawRect(0,0,this.params.w,this.params.h),s.graphics.endFill(),n.addChild(s);var h=(this.params.h-this.params.w)/2,o=this.createTextFieldNew(null,0,this.params.w,null,this.params.w,h,16777215,24);o.text="即将超越",n.addChild(o);var l=new egret.ImageLoader;l.once(egret.Event.COMPLETE,function(t){var e=t.currentTarget,a=new egret.Texture;a._setBitmapData(e.data);var r=i.createBitmapNew(a,null,h,i.params.w,null,0,i.params.w,i.params.w);n.addChild(r)},this),l.load(r.avatarUrl);var d=this.createTextFieldNew(null,this.params.w+h,this.params.w,null,this.params.w,h,16777215,24);d.text=this.formatNameString(this.checkSpeName(r.nickname)),n.addChild(d)}},e.prototype.initNear=function(t,e){var i=this,a=t+1,r=e[a];if(null!=r){var n=new egret.DisplayObjectContainer;this.addChild(n);var s=new egret.Shape;s.graphics.beginFill(2039331),s.graphics.drawRect(0,0,this.stageW,this.stageH),s.graphics.endFill(),n.addChild(s);var h=this.item_rankcolor;0==a?h=16714060:1==a?h=16732951:2==a&&(h=16769303);var o=this.createTextField(this.item_rankx,n.height,this.item_rankwidth,this.item_rankheight,h,this.item_rankfont,this.item_ranksize);o.text=-1==a?"":a+1+"";var l=new egret.ImageLoader;l.once(egret.Event.COMPLETE,function(t){var e=t.currentTarget,a=new egret.Texture;a._setBitmapData(e.data);var r=i.createBitmap(a,i.item_headx,n.height,i.item_headwidth,i.item_headheight);n.addChild(r)},this),l.load(r.avatarUrl);var d=this.createTextField(this.item_namex,n.height,this.item_namewidth,this.item_nameheight,this.item_namecolor,this.item_namefont,this.item_namesize,"left");d.text=this.formatNameString(this.checkSpeName(r.nickname)),n.addChild(d)}},e.prototype.initExceedFriend=function(t,e){var i=this,a=t+1,r=e[a];if(null!=r){var n=new egret.DisplayObjectContainer;this.addChild(n);var s=new egret.Shape;s.graphics.beginFill(2039331),s.graphics.drawRect(0,0,this.stageW,this.stageH),s.graphics.endFill(),n.addChild(s);var h=this.item_rankcolor;0==a?h=16714060:1==a?h=16732951:2==a&&(h=16769303);var o=this.createTextField(this.item_rankx,n.height,this.item_rankwidth,this.item_rankheight,h,this.item_rankfont,this.item_ranksize);o.text=-1==a?"":a+1+"";var l=new egret.ImageLoader;l.once(egret.Event.COMPLETE,function(t){var e=t.currentTarget,a=new egret.Texture;a._setBitmapData(e.data);var r=i.createBitmap(a,i.item_headx,n.height,i.item_headwidth,i.item_headheight);n.addChild(r)},this),l.load(r.avatarUrl);var d=this.createTextField(this.item_namex,n.height,this.item_namewidth,this.item_nameheight,this.item_namecolor,this.item_namefont,this.item_namesize,"left");d.text=this.formatNameString(this.checkSpeName(r.nickname)),n.addChild(d)}},e.prototype.initRankData=function(){this.listHeight=this.itemHeight*this.itemNumPerPage,this.itemWidth=this.listWidth,this.myItemY=this.listY+this.listHeight+this.myItemDisList},e.prototype.openFriendCloud=function(){var t=this;console.log("openFriendCloud"),wx.getFriendCloudStorage({keyList:[this.sortkey],success:function(e){t.initItems(e.data,!0)},fail:function(t){console.log("getFriendCloudStorage:error:",t)},complete:function(){console.log("getFriendCloudStorage:complete:")}})},e.prototype.openGroupCloud=function(){var t=this;console.log("openGroupCloud"),wx.getGroupCloudStorage({shareTicket:this.shareTicket,keyList:[this.sortkey],success:function(e){t.initItems(e.data,!1)},fail:function(t){console.log("getFriendCloudStorage:error:",t)},complete:function(){console.log("getFriendCloudStorage:complete:")}})},e.prototype.closeCloud=function(){console.log("closeCloud",this.numChildren),this.removeChildren(),this.scrollView.removeContent()},e.prototype.initItems=function(t,e){console.log("initItems:",t);var i=new egret.DisplayObjectContainer;this.scrollView.setContent(i),this.scrollView.width=this.listWidth,this.scrollView.height=this.listHeight,this.scrollView.x=(this.stageW-this.scrollView.width)/2,this.addChild(this.scrollView);for(var a,r=null!=this.userinfo.avatarUrl?this.userinfo.avatarUrl:"-1",n=-1,s=[],h=0;h<t.length;h++){var o=t[h];null!=o&&null!=o.KVDataList&&null!=o.KVDataList[0]&&s.push(o)}s=s.sort(this.sortfun),1==this.sorttype&&s.reverse();for(var h=0;h<s.length;h++){var o=s[h];r==o.avatarUrl&&(console.log("myrank:",n),a=o,n=h);var l=this.addItem(h,o);l.y=h*(this.itemHeight+this.itemDis),i.addChild(l)}this.scrollView.y=this.listY,this.initMyItem(n,a)},e.prototype.sortfun=function(t,e){if(null==t.KVDataList[0]||null==e.KVDataList[0])return-1;var i=parseInt(t.KVDataList[0].value),a=parseInt(e.KVDataList[0].value);return i>a?-1:1},e.prototype.initMyItem=function(t,e){if(null!=e&&null!=this.userinfo&&null!=this.userinfo.avatarUrl){var i={};i.avatarUrl=this.userinfo.avatarUrl,i.nickname=this.userinfo.nickname,i.KVDataList=e.KVDataList;var a=this.addItem(t,i);a.x=(this.stageW-a.width)/2,a.y=this.myItemY,this.addChild(a)}},e.prototype.addItem=function(t,e){var i=this,a=e.KVDataList,r={};if(null==a||0==a.length)r[this.sortkey]="未上榜",t=-1;else for(var n=0;n<a.length;n++){var s=a[n];r[s.key]=s.value}var h=new egret.DisplayObjectContainer;h.touchEnabled=!0,h.touchChildren=!1,h.width=this.itemWidth,h.height=this.itemHeight;var o=new egret.Shape;o.graphics.beginFill(t%2==0?this.item_bg_color1:this.item_bg_color2),o.graphics.drawRect(0,0,this.itemWidth,this.itemHeight),o.graphics.endFill(),h.addChild(o);var l=this.item_rankcolor;0==t?l=16714060:1==t?l=16732951:2==t&&(l=16769303);var d=this.createTextField(this.item_rankx,h.height,this.item_rankwidth,this.item_rankheight,l,this.item_rankfont,this.item_ranksize);d.text=-1==t?"":t+1+"",h.addChild(d);var c=new egret.ImageLoader;c.once(egret.Event.COMPLETE,function(t){var e=t.currentTarget,a=new egret.Texture;a._setBitmapData(e.data);var r=i.createBitmap(a,i.item_headx,h.height,i.item_headwidth,i.item_headheight);h.addChild(r)},this),c.load(e.avatarUrl);var m=this.createTextField(this.item_namex,h.height,this.item_namewidth,this.item_nameheight,this.item_namecolor,this.item_namefont,this.item_namesize,"left");m.text=this.formatNameString(this.checkSpeName(e.nickname)),h.addChild(m);var g=this.createTextField(this.item_scorex,h.height,this.item_scorewidth,this.item_scoreheight,this.item_scorecolor,this.item_scorefont,this.item_scoresize,"right");return g.text=this.getText(r[this.sortkey]),h.addChild(g),h},e.prototype.getText=function(t){var e=this.ParseTime2Format(Math.floor(t/1e3),"m:s"),i=t%1e3,a="";return a=10>i?"00"+i:100>i?"0"+i:i+"",e+":"+a},e.prototype.ParseTime2Format=function(t,e){function i(t){var e=t.toString();return 10>t&&(e="0"+t),e}void 0===e&&(e="h:m:s");var a=Math.floor(t/3600),r=Math.floor(t%3600/60),n=t%3600%60;return-1!=e.indexOf("h")?e=e.replace(/h/g,i(a)):r+=60*a,-1!=e.indexOf("m")?e=e.replace(/m/g,i(r)):-1!=e.indexOf("h")?n+=60*r:n=t,-1!=e.indexOf("s")&&(e=e.replace(/s/g,i(n))),e},e.prototype.createTextField=function(t,e,i,a,r,n,s,h,o){void 0===r&&(r=0),void 0===n&&(n="SimHei"),void 0===s&&(s=30),void 0===h&&(h="center"),void 0===o&&(o="middle");var l=new egret.TextField;return l.touchEnabled=!1,l.x=t,l.width=i,l.height=a,l.textColor=r,l.fontFamily=n,l.size=s,l.textAlign=h,l.verticalAlign=o,l.y=(e-a)/2,l},e.prototype.createTextFieldNew=function(t,e,i,a,r,n,s,h,o,l,d){void 0===s&&(s=16777215),void 0===h&&(h=30),void 0===o&&(o="SimHei"),void 0===l&&(l="center"),void 0===d&&(d="middle");var c=new egret.TextField;return null!=t&&(c.x=t),null!=e&&(c.y=e),null!=i&&(c.x=(i-r)/2),null!=a&&(c.y=(a-n)/2),null!=r&&(c.width=r),null!=n&&(c.height=n),c.textColor=s,c.size=h,c.fontFamily=o,c.textAlign=l,c.verticalAlign=d,c.touchEnabled=!1,c},e.prototype.createBitmap=function(t,e,i,a,r){var n=new egret.Bitmap(t);return n.touchEnabled=!1,n.x=e,n.width=a,n.height=r,n.y=(i-r)/2,n},e.prototype.createBitmapNew=function(t,e,i,a,r,n,s,h){void 0===e&&(e=0),void 0===i&&(i=0),void 0===a&&(a=null),void 0===r&&(r=null),void 0===n&&(n=0),void 0===s&&(s=null),void 0===h&&(h=null);var o=new egret.Bitmap(t);null!=s&&(o.width=s),null!=h&&(o.height=h),n%3==1?o.anchorOffsetX=o.width/2:n%3==2&&(o.anchorOffsetX=o.width);var l=Math.floor(n/3);return 1==l?o.anchorOffsetY=o.height/2:2==l&&(o.anchorOffsetY=o.height),null!=e&&(o.x=e),null!=i&&(o.y=i),null!=a&&(o.x=(a-s)/2),null!=r&&(o.y=(r-h)/2),o},e.prototype.checkSpeName=function(t){for(var e="",i=0;i<t.length;){var a=t.charCodeAt(i),r=t.charAt(i);i++,a>=65024&&65039>=a||(e+=r)}return e},e.prototype.formatNameString=function(t){for(var e=0,i="",a=0;a<t.length;a++)if(t.charCodeAt(a)>127||94==t.charCodeAt(a)?e+=2:e++,i+=t.charAt(a),e>12&&a<t.length-1)return i+"..";return t},e}(egret.DisplayObjectContainer);__reflect(Main.prototype,"Main"),window.Main=Main;